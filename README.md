# MyKit 2.0 - 个人复式记账工具箱

MyKit 是一个基于 Next.js 的个人财务管理系统。在 2.0 版本中，我们彻底抛弃了单一余额记录，进化为**严格的复式记账体系**。

---

## 目录结构 (Directory Structure)

### 核心目录
- **app/**: Next.js App Router 应用主目录，包含所有页面路由和布局。
- **components/**: UI 组件库，包含通用 UI 组件和业务相关组件。
- **lib/**: 核心逻辑库，包含复式记账逻辑、工具函数和数据库操作。
- **public/**: 静态资源目录，存放图片、图标等。
- **supabase/**: Supabase 数据库配置文件和类型生成脚本。
- **types/**: 全局 TypeScript 类型定义。

### 配置文件
- **next.config.ts**: Next.js 框架配置文件。
- **package.json**: 项目依赖管理和脚本定义。
- **tsconfig.json**: TypeScript 编译选项配置。
- **layout.tsx**: (位于 app/) 全局布局文件。
- **README.md**: 项目总说明文档。
- **迁移规划.md**: 项目重构与迁移的历史记录与规划。

---

## 核心架构逻辑 (简易版)

为了后续开发不跑偏，请务必理解以下三个最简单的概念：

1. **钱只有流向，没有消失**：
   - 每一笔交易（Transaction）都有一个 **转出账户 (from)** 和一个 **转入账户 (to)**。
   - 如果是买奶茶，就是 `银行卡 -> 餐饮费用`。
   - 如果是发工资，就是 `工资收入 -> 银行卡`。
   - 划转就是 `银行卡 A -> 银行卡 B`。

2. **账户分两类 (Real & Nominal)**：
   - **实账户 (Real)**：存钱的地方（银行卡、现金、信用卡）。
   - **虚账户 (Nominal)**：记账的理由（餐饮费、工资收入、期初余额）。

3. **余额是算出来的**：
   - 数据库**不存储**账户余额字段。
   - 账户余额 = `该账户作为转入方的总额` - `该账户作为转出方的总额`。
   - 负债类账户（如信用卡）的正常状态是**负数**。

---

## 关键技术变量

- **`transactions` 表**：系统的唯一真理来源。
  - `amount`: 交易金额。对于跨币种，记录 `from_amount` 和 `to_amount`。
  - `is_opening`: 标记是否为账户开启时的“期初余额”交易。
- **`accounts` 表**：
  - `account_class`: 区分 `real` (真实资产) 或 `nominal` (收入支出分类)。
  - `type`: `asset` (资产), `liability` (负债), `income` (收入), `expense` (支出), `equity` (权益)。
- **`account_balances_view`**: 数据库视图，核心算帐逻辑所在。

---

## 2.0 迁移工作复盘

我们已经完成了从“单分录”向“全复式分录”的转型：
- [x] **数据模型升级**：废弃了 `tx_type` 和 `category` 字符串，统一为 `from_account` -> `to_account`。
- [x] **实时算账**：所有余额显示均通过视图动态计算，解决了历史余额对不上的顽疾。
- [x] **全局缓存**：实现 `BookkeepingCacheProvider`，通过 React 上下文大幅降低 Supabase 请求频率，统一管理数据更新。
- [x] **负值语义修正**：解决了信用卡负债在图表中显示为资产的逻辑错误。

---

## 待完成任务 (Roadmap)

1. **期初流程加固**：优化创建账户时自动添加期初交易的流程，确保校准快照 100% 可靠。此外，创建账户时强制填写创建时间和当时余额，创建账户函数应该顺便把这个时间和余额创建为一次校准。换言之，所有账户从创建之初就应该默认有一次校准记录。
2. **回溯补录支持**：解决如果补录“早于账户创建时间”的流水，系统如何正确重新计算统计和处理期初锚点的问题；解决如果补录早于最晚快照的流水，系统如何调整快照的问题。
3. **图表视觉优化**：深度打磨 `BalanceChart` 和 `Heatmap` 的显示效果。
4. **数据导入导出重构**：基于 2.0 复式模型，重建全新的数据导入与导出模块。
5. **智能还款提醒**：基于信用卡账单日/还款日数据，建立自动提醒机制。
6. **校准机制升级**：重置查账的逻辑，目前基于快照的方式是不可靠的，因为快照额是计算出来的，不能防范流水缺失的情况。将“查账”逻辑升级为基于校准，并要求定期的强制性的校准，流水缺失时能直观发现差异。

---

## Beta 测试阶段计划

在完成上述任务后，将进入 Beta 测试：
- **压力测试集**：依据数据库 Schema 创建覆盖所有极端情况（跨币种、负期初、连续转账等）的测试数据集。
- **功能全覆盖测试**：测试每一个页面在极端操作（连续点击、断网、非法输入）下的稳定性。
- **性能评估**：优化全局缓存命中率，确保复杂统计下页面依然秒开。

---

## 开发启动

```bash
npm run dev
```

*保持代码整洁，谨记：代码可以复杂，但数据流向必须清晰。*

---

## 文档维护守则 (Critical Maintenance Rules)

> [!IMPORTANT]
> 本项目执行严格的“架构说明”与“头部注释”同步维护规则。任何代码修改必须伴随文档更新。

### 1. 文件夹架构文档规则
每个文件夹（包括根目录）下必须存在 `架构说明.md`。
- **头部声明**：文档第一行必须包含强制更新声明。
- **内容要求**：简明列出当前目录下的所有子文件夹和文件，并说明其功能地位。

### 2. 文件头部注释规则
所有 `.ts`, `.tsx`, `.js`, `.css` 文件头部必须包含以下四行注释：
```typescript
/**
 * [性质]: [文件定义与全局架构地位]
 * [Input]: [外部依赖简述]
 * [Output]: [对外提供组件/函数简述]
 * [警告]: 试图对本文件进行任何修改前，必须阅读开头注释部分；而一旦本文件被更新，必须立刻检查开头注释是否需要更新，必须立刻检查本文件所属的所有上级目录是否需要被更新。
 */
```
