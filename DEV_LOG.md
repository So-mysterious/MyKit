# 开发日志 (Development Log)

## 2025-11-28
- **每日打卡与周期性交易执行**：
    - **打卡表 (`daily_checkins`)**：记录每日打卡日期和时间，每天只能有一条记录。
    - **周期任务表扩展**：`periodic_tasks` 新增 `type`、`to_account_id`、`to_amount` 字段，支持划转类型。
    - **后端函数**：
        - `getTodayCheckin()`：获取今日是否已打卡。
        - `recordCheckin()`：记录打卡。
        - `calculateNextRunDate()`：根据周期计算下一次执行日期（支持 daily/weekly/biweekly/monthly/quarterly/yearly/custom_N）。
        - `executePeriodicTasks()`：核心执行逻辑，循环补偿多期未打卡的任务。
        - `runGlobalRefresh()`：全局刷新入口（周期交易 + 自动快照预留）。
        - `handleDailyCheckin()`：每日打卡入口。
    - **仪表盘打卡按钮**：
        - 未打卡：显示"每日打卡"（实心按钮），点击执行打卡 + 全局刷新。
        - 已打卡：显示"全局刷新"（描边按钮），点击仅执行全局刷新。
        - 执行后显示结果提示（执行了 N 笔周期交易）。
    - **周期交易执行逻辑**：
        - 检查所有 `is_active = true` 且 `next_run_date <= today` 的任务。
        - 循环执行直到 `next_run_date > today`（补偿多期）。
        - 划转类型创建两笔关联流水（转出 + 转入）。
        - 周期任务的 `description` 直接作为流水备注。

- **页面布局与标题风格统一**：
    - **Layout 统一控制**：
        - 根容器：`flex h-[calc(100vh-3.5rem)]`
        - 内容区域：`flex-1 overflow-y-auto p-6`（统一 24px padding）
    - **页面根容器规范**：
        - 普通页面：`space-y-6`，不再设置 padding
        - 特殊页面（流水）：使用 `-m-6` 抵消 layout padding，顶部使用 `pt-6` 保持一致
    - **标题区域规范**：
        - 外层容器：`flex items-center justify-between`
        - 标题容器：`space-y-1`（统一间距）
        - 英文：`text-xs font-semibold text-gray-500 uppercase tracking-widest`
        - 中文标题：`text-2xl font-bold tracking-tight`
        - 说明文字：`text-sm text-gray-500`
    - 已统一的页面：仪表盘、流水明细、账户管理、周期交易、查账中心、设置
    - 流水页面统计指标样式简化：移除背景框，仅保留颜色区分

- **周期性交易模块 (Periodic Tasks)**：
    - **数据库字段**：使用 `is_active` 字段（默认 `TRUE`）控制任务启用状态，`FALSE` 表示暂停。
    - **后端 Actions**：在 `lib/bookkeeping/actions.ts` 中新增完整 CRUD 操作：
        - `getPeriodicTasks`：获取任务列表（含账户信息联查）。
        - `createPeriodicTask`：创建新任务。
        - `updatePeriodicTask`：更新任务信息。
        - `deletePeriodicTask`：删除任务。
        - `togglePeriodicTaskActive`：切换启用/暂停状态。
    - **侧边栏入口**：在记账模块侧边栏新增"周期交易"入口（`CalendarClock` 图标）。
    - **周期交易页面 (`/bookkeeping/periodic`)**：
        - **交易类型**：支持支出、收入、划转三种类型（划转可用于周期性充值等场景）。
        - **周期设计**：
            - 预设周期：每天、每周、每两周、每月（自然月）、每季度、每年
            - 自定义天数：支持任意 1-365 天的自定义周期
            - 自然月逻辑：1月31日 → 2月28/29日 → 3月31日（与主流订阅服务一致）
        - **首次执行日期**：用户设置首次执行日期，系统自动计算下一次执行时间。
        - **按钮布局优化**：点击"新建任务"后，按钮变为"取消"和"完成"并排显示在标题栏。
        - **任务列表**：简洁无边框风格，悬停显示操作按钮。
        - **行内编辑**：点击编辑按钮后直接在列表行内展开编辑表单。
        - **暂停/恢复**：一键切换任务状态，暂停任务显示"已暂停"标签并降低透明度。
        - **统计摘要**：底部显示任务总数、启用数及月预计支出。

- **侧边栏 Tooltip 修复（使用 React Portal）**：
    - 修复侧边栏 tooltip 被页面内容遮挡的问题。
    - **根本原因**：CSS z-index 只在同一层叠上下文内生效。tooltip 的 `z-30` 相对于侧边栏内部，无法穿透到内容区域之上。
    - **最终方案**：使用 `createPortal` 将 tooltip 渲染到 `document.body`，完全脱离 DOM 层级限制。
    - **实现细节**：
        - 将 `<Link>` 抽取为 `SidebarLink` 子组件，管理独立的 hover 状态
        - 使用 `useRef` 获取链接元素位置，计算 tooltip 的 `top/left`
        - Portal 渲染的 tooltip 使用 `z-[9999]` 确保始终在最上层
    - **架构说明**：侧边栏是独立组件 `components/Sidebar.tsx`，在 `layout.tsx` 中统一调用，所有页面共用。

- **UI/UX 细节优化与修复**：
    - **流水列表布局 (`TransactionsPage`)**：
        - **视觉统一**：移除收入图标的绿色背景圈，统一收/支/转三种类型的图标风格（仅保留颜色区分）。
        - **对齐校准**：调整 Grid 列宽比例，确保标签、备注、时间、账户、金额各列严格垂直对齐。
        - **金额格式化**：统一所有交易类型（含划转）的金额显示格式为 `符号 + 币种 + 金额` (e.g. `¥100.00 ➔ $15.00`)。
    - **备注栏高级交互**：
        - **智能截断**：实施严格的 10 字符限制，超出部分显示浅色省略号，并强制不换行。
        - **悬停浮窗**：引入 `React Portal` 实现悬停浮窗，将完整备注渲染至 `body` 层级，解决在滚动容器中被裁剪的问题。
    - **划转逻辑修复**：
        - 修复了添加划转时目标账户显示错误的 Bug（防止自转）。
        - 记账弹窗中划转类型现在也强制要求选择标签（Category），不再默认为“内部划转”。

- **标签 & 全局配色系统实装**：
    - **核心改造**：移除代码中所有写死的标签常量（如“餐饮”、“工资”等），全面对接数据库 `bookkeeping_tags` 表。
    - **记账弹窗 (`TransactionModal`)**：动态拉取数据库中的启用标签，根据交易类型（支出/收入/划转）实时筛选展示。
    - **流水列表 (`TransactionsPage`)**：
        - 筛选器不再使用预设列表，而是基于“当前页面已有流水的标签”与“数据库启用标签”的并集生成筛选选项。
        - 确保历史数据中的废弃标签依然可以被筛选和正常显示。
    - **图表组件适配**：
        - `LifeRecipe` (甜甜圈图)、`Heatmap` (热力图)、`TransactionExplorer` (趋势图) 均已接入 `bookkeeping_settings` 中的全局配色配置。
        - 移除了图表中对具体分类颜色的硬编码，统一使用“支出/收入/划转”三大类主色，并利用透明度/色阶区分细节。
    - **数据一致性**：更新了 `constants.ts`，标记旧的常量为废弃，确保新逻辑不再依赖它们。

## 2025-11-21
- **流水筛选体验优化 (v2)**：
    - **交互样式升级**：自定义 `FilterChip` 按钮，增加圆角、阴影与 hover 动效，统一应用于交易类型、金额、时间与账户等筛选项。
    - **时间&金额预设**：新增“全部”时间选项，同时保留四个快捷区间；金额与时间继续与交易类型同排展示，减少折行。
    - **标签筛选重构**：改为分组网格展示（支出/收入/划转），直接点击即可多选，并实时显示已选标签摘要。
    - **快捷操作**：新增“清空筛选”按钮，一键还原所有条件。
    - **后端过滤完善**：`getTransactions` 新增最小/最大金额过滤逻辑，按绝对值区间查询正负金额，确保金额筛选真正生效。

- **流水筛选体验优化 (v3)**：
    - **统一按钮组件**：引入新的 `TimeRangeSelector` 分段按钮，承载交易类型、金额、时间、账户及标签筛选，按钮视觉与动效统一。
    - **操作栏布局**：`清空筛选` 与 `筛选` 并排放置在标题栏右侧，保持一致的描边样式，筛选展开时自动高亮。
    - **标签行重写**：支出/收入/划转三类标签各占一行，左侧标签标题与右侧选项保持同一水平方向，支持横向滚动且默认不换行。
    - **业务逻辑调整**：将筛选状态集中映射到新组件，完善账户/标签多选与“全部”选项的清空逻辑，体验与后端过滤保持一致。
    - **宽度 & 视觉修复**：去掉“近半年”选项并压缩筛选结构，避免打开筛选时页面横向拉伸；修正分段按钮的选中背景样式，确保文字与底色同步高亮。
    - **滚动边界**：去除顶部模糊 `sticky` 区块，让滚动仅发生在流水列表容器内部，表头不再遮挡筛选区。

- **流水页面 (Transactions) 重构**：
    - **筛选区域布局优化**：
        - 将“金额范围”和“时间范围”移动到与“交易类型”同一行，节省纵向空间。
        - 移除了时间范围的自定义日期选择器，仅保留“近3天”、“近一周”、“近一月”、“近半年”四个快捷选项。
        - 将“标签筛选”改为下拉菜单 (Dropdown Menu) 形式，支持多选，并独占一行以容纳更多内容。
    - **组件库应用**：引入 `DropdownMenu` 组件处理标签筛选。

- **记账模块仪表盘优化**：
    - **图表重构**：移除 `recharts` 依赖，将所有图表组件替换为原生 SVG/CSS 实现，提高性能并确保存粹的视觉控制。
    - **Heatmap 组件**：
        - 重写逻辑以完全复刻 GitHub 贡献图风格。
        - 年度视图：改为以周为列（约53列），以日为行（7行）的布局，确保正确显示过去一年的数据。
        - 月度视图：保持标准日历网格布局。
        - 优化颜色层级，收入使用绿色系，支出使用红色系。
    - **TransactionExplorer 组件**：
        - 使用 SVG `<polyline>` 实现折线图。
        - 实现自定义坐标轴计算和交互（Hover 显示数值）。
    - **LifeRecipe 组件**：
        - 使用 SVG `<circle>` 和 `stroke-dasharray` 实现甜甜圈图（Donut Chart）。
        - 优化图例交互和中心文字显示。

## 2025-11-19
- **项目初始化**：
    - 阅读并分析项目规划文档 `1.txt`。
    - 建立项目文档 `README.md`。
    - 确认核心架构：Next.js App Router + 嵌套布局 + Supabase。
    - 确认设计理念：逻辑内聚于前端，模块化设计。

## 2025-11-20
- **架构搭建**：
    - 初始化 Next.js 项目 (TypeScript, Tailwind)。
    - 实现 TopNavBar 和 Sidebar 布局。
    - 搭建 Supabase 数据库 Schema (4张核心表：accounts, transactions, snapshots, periodic_tasks)。
    - 定义 TypeScript 类型 (`types/database.ts`) 和常量 (`lib/constants.ts`)。
- **开发规划调整**：
    - **数据模型优化**：放弃 JSON 字段，改为平铺字段（如信用卡信息）。
    - **开发模式**：采用“前端优先”策略。先完成所有 UI 组件和页面的交互（使用 Mock 数据），确认样式和体验无误后，再接入后端逻辑。
- **记账模块 UI 开发计划**：
    1.  **组件开发**：
        - `TransactionModal`: 记账弹窗 (核心交互)。
        - `AccountCard`: 账户卡片 (展示余额)。
        - `SnapshotDialog`: 余额校准弹窗。
    2.  **页面组装**：
        - `accounts/page.tsx`: 账户列表。
        - `transactions/page.tsx`: 流水列表 + 筛选。
        - `dashboard/page.tsx`: 概览 + 入口。

## 2025-11-24
- **查账提醒与一键查账**：
    - 新增 `reconciliation_issues` 表（schema + TS 类型），专门记录任意两个快照之间的差额异常，并为后续处理提供状态字段。
    - 在 `lib/bookkeeping/actions.ts` 中实现 `runReconciliationCheck`、`getReconciliationIssues`、`resolveReconciliationIssue` 以及 `getAccountsMeta`，复用统一逻辑生成/查询提醒。
    - `SnapshotDialog` 的“校正余额”流程在检测到差额时自动触发查账逻辑，确保手动校正与一键查账共用同一套提醒机制。
    - `bookkeeping/settings` 页面重写为客户端组件，提供“一键查账”弹窗（可选择账户+时间范围）、提醒列表渲染、手动刷新与“标记已处理”操作。
- **查账逻辑强化 (v2)**：
    - `runReconciliationCheck` 现会在每次执行前清空对应账户的全部提醒并重新扫描完整快照区间，避免重复/冲突的警告。
    - 新增 `getSnapshotsByIds` 与 `regenerateIssuesForAccounts`，支持 UI 批量拉取快照详情以及补流水后的全量重算。
    - 设置页提醒卡片改为展示起/终点快照详情（余额、录入时间、来源），并以“流水总和 / 后一次-前一次 / 差额”三段式输出差异。
    - “去查账”动作升级为“补流水”流程：在提醒卡片内直接唤起 `TransactionModal`，流水记账成功后自动对相关账户（含划转双侧）重跑查账检查。
- **即将开展的记账模块迭代**：
    - **路由调整**：侧边栏新增“查账”独立入口（迁移现有查账页面）以及“周期性交易”入口（管理月费/固定收入等任务）。
    - **周期性交易页**：展示 `periodic_tasks` 列表，支持新建/编辑/暂停/手动执行，后续与 `runPeriodicChecks` 联动。
    - **设置模块**（记账局部配置）：
        1. 金额显示规则（千分位、保留小数、默认币种）。
        2. 自动快照开关、周期（天数）、容差阈值。
        3. 数据导入/导出（CSV/XLS），直接在前端生成或解析文件。
    - **数据库新增**：
        - `bookkeeping_settings`、`bookkeeping_tags`、`transaction_tag_links`、`bookkeeping_available_tags` 视图。
    - **类型同步**：`types/database.ts` 已加入上述表定义，后续代码改造可直接使用类型提示。
